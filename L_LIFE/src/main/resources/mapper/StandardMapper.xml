<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kosa.com.suntofu.L_LIFE.standard.dao.StandardDAO">

    <!-- 스탠다드 메인 (가구이미지, 가구명, 가구브랜드, 코인개수) -->
    <select id = "selectAllStandard">
        SELECT
            lf.lf_id,
            lf.lf_img_main,
            lfb.lf_brand_name,
            lf.lf_name,
            lf.lf_st_coin
        FROM
            LLifeFurniture lf
        JOIN
            LFurnitureBrand lfb ON lf.lf_brand_id = lfb.lf_brand_id
        WHERE
            lf_sub_type = 0
    </select>

    <!-- 라이브 리스트 가져오기 -->
    <select id = "selectAllLiveStream" resultType="StandardLiveVo">
        SELECT
            LS.l_stream_name,
            LS.l_stream_time,
            TO_CHAR(LS.l_stream_time, 'MM/DD') AS stream_date,
            TO_CHAR(LS.l_stream_time, 'HH24:MI') AS stream_time,
            LFP.lf_package_name,
            LFP.lf_package_img,
            LFP.lf_package_st_coin
        FROM
            LSProduct LSP
        JOIN
            LiveStream LS ON LSP.l_stream_id = LS.l_stream_id
        JOIN
            LFPackage LFP ON LSP.lf_package_id = LFP.lf_package_id
        WHERE
            LFP.lf_package_type = 0
    </select>

    <!-- 카테고리 필터 -->
    <select id="selectStandardProductByCategory" resultType="StandardVo">
        SELECT
            lf.lf_id,
            lf.lf_img_main,
            lfb.lf_brand_name,
            lf.lf_name,
            lf.lf_st_coin,
            lfc.lf_category_id
        FROM
            LLifeFurniture lf
        JOIN
            LFurnitureBrand lfb ON lf.lf_brand_id = lfb.lf_brand_id
        JOIN
            LFurnitureCategory lfc ON lf.lf_category_id = lfc.lf_category_id
        WHERE
            lfc.lf_category_id = #{fCategoryId}
        AND
            lf_sub_type = 0
    </select>

    <!-- 상품 검색(브랜드명, 상품명) -->
    <select id="selectStandardProductByKeyword" resultType="StandardVo">
        SELECT
            lf.lf_id,
            lf.lf_img_main,
            lfb.lf_brand_name,
            lf.lf_name,
            lf.lf_st_coin
        FROM
            LLifeFurniture lf
        JOIN
            LFurnitureBrand lfb ON lf.lf_brand_id = lfb.lf_brand_id
        WHERE
            lf.lf_sub_type = 0
        AND
            (UPPER(lfb.lf_brand_name) LIKE '%' || UPPER(#{keyword}) || '%'
             OR UPPER(lf.lf_name) LIKE '%' || UPPER(#{keyword}) || '%')
    </select>

    <!-- 스탠다드 상품(브랜드, 분위기, 코인개수) 검색 -->
    <select id="searchStandardProductByFilter" resultType="StandardVo">
        SELECT
            lf.lf_id,
            lf.lf_img_main,
            lfb.lf_brand_name,
            lf.lf_name,
            lf.lf_st_coin,
            lfb.lf_brand_id
        FROM
            LLifeFurniture lf
        JOIN
            LFurnitureBrand lfb ON lf.lf_brand_id = lfb.lf_brand_id
        JOIN
            LFurnitureMood lfm ON lf.lf_mood_id = lfm.lf_mood_id
        WHERE
           lf.lf_sub_type = 0
        AND
            lfb.lf_brand_id IN
            <foreach collection="lfBrandIds" item="brandId" open="(" separator="," close=")">
                #{brandId}
            </foreach>
        AND
            lfm.lf_mood_id IN
            <foreach collection="lfMoodIds" item="moodId" open="(" separator="," close=")">
                #{moodId}
            </foreach>
        AND
           lf.lf_st_coin BETWEEN #{minCoin} AND #{maxCoin}
    </select>

    <!-- 스탠다드 상세페이지 -->
    <select id = "selectStandardDetailById">
        SELECT
            lf.lf_id,
            lf.lf_img_main,
            lfb.lf_brand_name,
            lf.lf_name,
            lf.lf_st_coin,
            lf.lf_st_grade,
            lf.lf_sub_comment
        FROM
            LLifeFurniture lf
        JOIN
            LFurnitureBrand lfb ON lf.lf_brand_id = lfb.lf_brand_id
        WHERE
            lf_sub_type = 0
        AND
            lf_id = #{lfId}
    </select>

    <!-- 스탠다드 상세페이지 옵션 -->
    <select id="selectStandardOptionById" resultType="StandardOptionVo">
        SELECT
            s.lf_id,
            s.stock_amount,
            lfo.lf_opt_id,
            lfo.lf_opt_name
        FROM
            Stock s
        JOIN
            LFurnitureOption lfo ON s.lf_opt_id = lfo.lf_opt_id
        WHERE
            s.lf_id = #{lfId}
    </select>

    <!-- 스탠다드 상세페이지 리퍼 정보 -->
    <select id="selectStandardRefurById" resultType="StandardRefurVo">
        SELECT
            lf.lf_id,
            lf.lf_st_grade,
            rfi.refur_img_id,
            rfi.refur_img_url
        FROM
            LLifeFurniture lf
        JOIN
            RefurbishImage rfi ON lf.lf_id = rfi.lf_id
        WHERE
            lf.lf_sub_type = 0
        AND
            lf.lf_id = #{lfId}
    </select>

    <!-- 스탠다드 추천(구독가능한 제품 + 해당 카테고리 제품을 랜덤으로 추천) -->
    <select id="selectStandardRecommendation" resultType="StandardVo">
        SELECT
            lf.lf_id,
            lf.lf_img_main,
            lfb.lf_brand_name,
            lf.lf_name,
            lf.lf_st_coin
        FROM
            LLifeFurniture lf
        INNER JOIN
            LFurnitureCategory lfc ON lf.lf_category_id = lfc.lf_category_id
        JOIN
            LFurnitureBrand lfb ON lf.lf_brand_id = lfb.lf_brand_id
        JOIN
            LLifeFurniture recommend ON lf.lf_category_id = recommend.lf_category_id
        WHERE
            recommend.lf_sub_issub = 0
        AND
            lf.lf_sub_type = 0
        AND
            recommend.lf_id IN (
                SELECT #{lfId}
                FROM LLifeFurniture
                WHERE lf_category_id = lf.lf_category_id
                AND lf_sub_issub = 0
        )
        ORDER BY DBMS_RANDOM.VALUE
    </select>

    <!--스탠다드 재입고 알림 신청-->
    <select id="selectStandardStockAmount" resultType="StandardRestockVo">
        SELECT
            s.lf_opt_id,
            s.lf_id,
            s.stock_amount
        FROM
            Stock s
        WHERE
            s.lf_opt_id = #{lfOptId}
        AND
            s.lf_id = #{lfId}
    </select>

    <!-- 재입고 알림 신청 시 예약 테이블에 insert -->
    <insert id="insertOptionToReservation" parameterType="StandardOptionVo">
        INSERT INTO reservation (m_id, lf_id, lf_opt_id)
        VALUES (#{mId}, #{lfId}, #{lfOptId})
    </insert>

    <!-- 장바구니 테이블에 insert -->
    <insert id="insertProductToCart" parameterType="StandardSubscriptionVo">
        {CALL
            DECLARE
                v_member_id NUMBER :=0;
            BEGIN
                SELECT count(SUBSCRIPTION.m_id)
                INTO v_member_id
                FROM SUBSCRIPTION where m_id = #{mId};

                IF v_member_id > 0 THEN
                    INSERT INTO CART (lf_id, m_id, lf_opt_id)
                    VALUES (#{lfId}, #{mId}, #{lfOptId});
                ELSE
                    RAISE_APPLICATION_ERROR(-20002, 'No subscription found for the user');
            END IF;
            END
        }
    </insert>


    <insert id="insertReview" useGeneratedKeys="false" parameterType="ReviewVo" >
        insert into review(lf_review_title, lf_review_content, m_id, lf_id, lf_review_rating, lf_review_ser_rating, lf_review_del_rating)
        values(#{lfReviewTitle}, #{lfReviewContent}, #{mId}, #{lfId}, #{lfReviewRating},#{lfReviewSerRating},#{lfReviewDelRating})

        <selectKey keyProperty="lfReviewId" resultType="int" order="AFTER">
            SELECT lf_review_id FROM review WHERE m_id = #{mId} and lf_id = #{lfId}
        </selectKey>

    </insert>

    <insert id="insertReviewImg">
        <selectKey keyProperty="maxSeq" resultType="int" order="BEFORE">
            SELECT NVL(MAX(r_img_id), 0) FROM reviewImage
        </selectKey>
        INSERT INTO reviewImage (r_img_id, r_img_url, lf_review_id)
        <foreach collection="list" item="item" index="idx" separator="UNION ALL">
            SELECT #{maxSeq} + #{idx}, #{item.rImgUrl}, #{item.lfReviewId} FROM DUAL
        </foreach>
    </insert>


</mapper>
